From 27375814accd0722ea937d5a40f4068c68dee65f Mon Sep 17 00:00:00 2001
From: vchirca <Valentin.Chirca@windriver.com>
Date: Thu, 9 Mar 2017 18:17:54 +0200
Subject: [PATCH] Fix for V7COR-4861

---
 vxworks-7/pkgs/os/lang-lib/libc/libc-usr/h/wchar.h     |  3 +++
 vxworks-7/pkgs/os/lang-lib/libc/libc-usr/layer.vsbl    |  3 ++-
 vxworks-7/pkgs/os/lang-lib/libc/libc-usr/libc-usr.spec |  8 +++++++-
 .../share_src/regression/libc/V7COR-3704/Makefile      |  5 +++--
 .../regression/libc/V7COR-3704/V7COR-3704.cpp          |  3 +++
 .../regression/libc/V7COR-3704/V7COR-3704f.cpp         | 18 ++++++++++++++++++
 6 files changed, 36 insertions(+), 4 deletions(-)
 create mode 100644 vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/V7COR-3704f.cpp

diff --git a/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/h/wchar.h b/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/h/wchar.h
index 896d1269ddb..cce2cce80ae 100644
--- a/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/h/wchar.h
+++ b/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/h/wchar.h
@@ -8,6 +8,9 @@
 _C_STD_BEGIN
 
 #ifndef _NO_WINDRIVER_MODIFICATIONS
+#if defined(_STDARG_H) && defined(_C_IN_NS) && defined(__cplusplus)
+typedef ::va_list va_list;
+#endif
 #include <stdarg.h>
 #if !defined(__VA_LIST)
 #define __VA_LIST
diff --git a/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/layer.vsbl b/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/layer.vsbl
index e492682a6e5..5bbf34e769b 100644
--- a/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/layer.vsbl
+++ b/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/layer.vsbl
@@ -10,6 +10,7 @@
 /*
 Modification history
 --------------------
+09mar17,val  1.0.6.4: fixed V7COR-4861
 05jan17,zjl  1.0.6.3:vxTest code cleanup
 24oct16,mze  fix for (V7COR-4023)
 14oct16,lau  1.0.6.2: fixes for V7COR-4631 and V7COR-4597
@@ -64,7 +65,7 @@ Layer  LIBC_USER
     {
     SYNOPSIS        VxWorks lang-lib user support
     HELP            This provides VxWorks lang-lib user support.
-    VERSION         1.0.6.3
+    VERSION         1.0.6.4
     VENDOR          Wind River
     FEATURE         COREOS
     VSB_REQUIRES    RTP
diff --git a/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/libc-usr.spec b/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/libc-usr.spec
index 8a485be3286..9eddd44d9ec 100644
--- a/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/libc-usr.spec
+++ b/vxworks-7/pkgs/os/lang-lib/libc/libc-usr/libc-usr.spec
@@ -6,6 +6,7 @@
 #
 # Modification history
 # --------------------
+# 09mar17,val  1.0.6.4: fixed V7COR-4861
 # 05jan17,zjl  1.0.6.3:vxTest code cleanup
 # 04jan17,dlk  Update changelog (F972, V7COR-4741)
 # 24oct16,mze  fix for (V7COR-4023)
@@ -62,7 +63,7 @@
 
 Name: libc-usr
 Summary: VxWorks lang-lib user support
-Version: 1.0.6.3
+Version: 1.0.6.4
 Group: os/lang-lib/libc
 Prefix: /vxworks-7/pkgs/os/lang-lib/libc/libc-usr
 VXDest: /vxworks-7/pkgs/os/lang-lib/$os_lang_lib_libc_ns_container/libc-usr
@@ -93,6 +94,11 @@ VxWorks lang-lib user support
 %{prefix}/*
 
 %changelog
+* Thu Mar 09 2017  Wind River 1.0.6.4
+- [LIBC_USER]
+  - Added va_list under std namespace for the scenario where stdarg.h
+    is included as the first header (V7COR-4861)
+
 * Thu Jan 05 2017  Wind River 1.0.6.3
 - [LIBC_USER]
   - Fixes for clean C++ compile with boost (F972)
diff --git a/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/Makefile b/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/Makefile
index 9fba94098a7..6f739cebe99 100644
--- a/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/Makefile
+++ b/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/Makefile
@@ -2,7 +2,7 @@
 # Regression test for: V7COR-3704
 # GNU C++11 fails to build boost library serialization because va_list not found in std namespace
 #
-# Copyright (c) 2015 Wind River Systems, Inc
+# Copyright (c) 2015, 2017 Wind River Systems, Inc
 #
 # The right to copy, distribute, modify or otherwise make use
 # of this software may be licensed only pursuant to the terms
@@ -12,13 +12,14 @@
 #
 # modification history
 # --------------------
+# 02mar17,val  extended for V7COR-4861
 # 19oct15,lau  created
 #
 
 include $(WIND_USR_MK)/defs.default.mk
 
 EXE  = V7COR-3704.vxe
-OBJS = V7COR-3704.o V7COR-3704b.o V7COR-3704c.o V7COR-3704d.o V7COR-3704e.o
+OBJS = V7COR-3704.o V7COR-3704b.o V7COR-3704c.o V7COR-3704d.o V7COR-3704e.o V7COR-3704f.o
 
 RTP_BASE_DIR = V7COR-3704
 
diff --git a/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/V7COR-3704.cpp b/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/V7COR-3704.cpp
index 631884acde1..765e5ade0a5 100644
--- a/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/V7COR-3704.cpp
+++ b/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/V7COR-3704.cpp
@@ -3,6 +3,7 @@ Test for V7COR-3704 - GNU C++11 fails to build boost library serialization becau
 
 modification history
 --------------------
+02mar17,val  extended for V7COR-4861
 19oct15,lau  created
 */
 
@@ -15,12 +16,14 @@ extern int case_b();
 extern int case_c();
 extern int case_d();
 extern int case_e();
+extern int case_f();
 
 int main() {
     exit_status += case_b();
     exit_status += case_c();
     exit_status += case_d();
     exit_status += case_e();
+    exit_status += case_f();
 
     CHECK_RETURN(exit_status);
 }
diff --git a/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/V7COR-3704f.cpp b/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/V7COR-3704f.cpp
new file mode 100644
index 00000000000..79f599870e8
--- /dev/null
+++ b/vxworks-7/pkgs/test/vxtestv2/compiler/share_src/regression/libc/V7COR-3704/V7COR-3704f.cpp
@@ -0,0 +1,18 @@
+/*
+Test for V7COR-3704 - GNU C++11 fails to build boost library serialization because va_list not found in std namespace
+
+modification history
+--------------------
+02mar17,val  created
+*/
+#include <stdarg.h>
+#include <wchar.h>
+
+int case_f() {
+    va_list a;
+    #if __cplusplus >= 201103L
+    std::va_list b;
+    #endif
+
+    return 0;
+}
-- 
2.12.1

